on: push
jobs:
  test:
    permissions:
      id-token: write
      contents: write
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
         - {a: 1}
         - {a: 2, stable: true}
    steps:
      - uses: actions/checkout@v4
      - if: matrix.stable
        id: stable
        run: >
          git for-each-ref --sort=-creatordate --format "%(creatordate:unix) %(refname:short)" refs/tags |
          awk "{if (\$1 > strftime(\"%s\") - $DAYS_BEFORE_STABLE * 24 * 60 * 60) print \$2}" | tail -1 
        env:
          DAYS_BEFORE_STABLE: 15
      - run: echo ${{ steps.stable.outputs.tag || github.ref_name }}
